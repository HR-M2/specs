# 实现计划

- [x] 1. 项目初始化和基础架构
  - [x] 1.1 创建 FastAPI 项目目录结构
    - 创建 HRM2-FastAPI-Backend 目录
    - 创建 app/, tests/, media/, alembic/ 子目录
    - 创建 requirements.txt, .env.example, README.md
    - _需求: 11.1, 13.2_
  - [x] 1.2 配置 FastAPI 应用入口
    - 创建 app/main.py，配置 FastAPI 实例
    - 配置 CORS 中间件
    - 配置静态文件和媒体文件服务
    - 配置 Swagger UI 文档路径 /api/docs/
    - _需求: 11.1, 11.5, 13.3, 13.4_
  - [x] 1.3 配置数据库连接
    - 创建 app/database.py，配置 SQLAlchemy 异步引擎
    - 创建 app/config.py，支持环境变量配置
    - 配置 Alembic 数据库迁移
    - _需求: 11.2, 11.4, 13.1_
  - [x] 1.4 创建统一响应格式
    - 创建 app/schemas/common.py，定义 ApiResponse 模型
    - 创建 app/utils/response.py，封装响应工具函数
    - _需求: 1.4, 1.5, 1.6_
  - [x] 1.5 编写属性测试：统一响应格式
    - **Property 1: 统一响应格式**
    - **验证: 需求 1.4**

- [x] 2. 数据模型实现
  - [x] 2.1 创建 Position 模型
    - 创建 app/models/position.py
    - 定义岗位字段：position, department, required_skills 等
    - _需求: 2.1, 12.1, 12.2_
  - [x] 2.2 创建 Resume 模型
    - 创建 app/models/resume.py
    - 定义统一简历字段：filename, file_hash, content, screening_score 等
    - _需求: 3.1, 4.5, 12.1, 12.2_
  - [x] 2.3 创建 ScreeningTask 模型
    - 创建 app/models/screening.py
    - 定义任务状态枚举和字段
    - _需求: 4.1, 12.1_
  - [x] 2.4 创建 VideoAnalysis 模型
    - 创建 app/models/video.py
    - 定义视频分析字段和状态
    - _需求: 8.1, 12.1_
  - [x] 2.5 创建 InterviewSession 模型
    - 创建 app/models/interview.py
    - 定义会话字段和 JSON 问答记录
    - _需求: 10.1, 12.1_
  - [x] 2.6 创建 ComprehensiveAnalysis 模型
    - 创建 app/models/recommend.py
    - 定义综合分析结果字段
    - _需求: 9.1, 12.1_
  - [x] 2.7 创建 ResumePositionAssignment 关联模型
    - 在 app/models/position.py 中添加关联表
    - _需求: 2.6, 12.4_
  - [x] 2.8 生成数据库迁移并初始化
    - 运行 alembic revision 生成迁移脚本
    - 运行 alembic upgrade head 创建表
    - _需求: 12.5_
  - [x] 2.9 编写属性测试：UUID 格式一致性
    - **Property 10: UUID 格式一致性**
    - **验证: 需求 12.2**

- [x] 3. 岗位管理 API (/api/positions/)
  - [x] 3.1 创建岗位 Pydantic 模式
    - 创建 app/schemas/position.py
    - 定义 PositionCreate, PositionUpdate, PositionResponse
    - _需求: 1.2_
  - [x] 3.2 实现岗位列表和创建 API
    - 创建 app/api/positions.py
    - 实现 GET /api/positions/ 和 POST /api/positions/
    - _需求: 2.1, 2.2_
  - [x] 3.3 实现岗位详情、更新、删除 API
    - 实现 GET/PUT/DELETE /api/positions/{position_id}/
    - _需求: 2.3, 2.4, 2.5_
  - [x] 3.4 实现简历分配和移除 API
    - 实现 POST /api/positions/{position_id}/resumes/
    - 实现 DELETE /api/positions/{position_id}/resumes/{resume_id}/
    - _需求: 2.6, 2.7_
  - [x] 3.5 实现 AI 生成岗位要求 API
    - 实现 POST /api/positions/ai/generate/
    - 集成 AI 服务调用（模拟实现，待 AI 服务集成阶段完善）
    - _需求: 2.8_
  - [x] 3.6 编写属性测试：岗位创建后可查询
    - **Property 5: 岗位创建后可查询**
    - **验证: 需求 2.2, 2.3**

- [x] 4. Checkpoint - 确保所有测试通过
  - [x] 确保所有测试通过，如有问题请询问用户

- [x] 5. 简历库 API (/api/library/)
  - [x] 5.1 创建简历 Pydantic 模式
    - 创建 app/schemas/resume.py
    - 定义 ResumeUpload, ResumeResponse, LibraryListResponse
    - _需求: 1.2_
  - [x] 5.2 实现简历库列表 API
    - 实现 GET /api/library/
    - 支持分页和筛选参数 (keyword, is_screened, is_assigned)
    - _需求: 3.1_
  - [x] 5.3 实现简历上传 API
    - 实现 POST /api/library/
    - 处理文件哈希计算和去重
    - _需求: 3.2_
  - [x] 5.4 实现简历详情、更新、删除 API
    - 实现 GET/PUT/DELETE /api/library/{id}/
    - _需求: 3.3, 3.4, 3.5_
  - [x] 5.5 实现批量删除和哈希检查 API
    - 实现 POST /api/library/batch-delete/
    - 实现 POST /api/library/check-hash/
    - _需求: 3.6, 3.7_
  - [x] 5.6 编写属性测试：分页数据一致性
    - **Property 3: 分页数据一致性**
    - **验证: 需求 3.1**
  - [x] 5.7 编写属性测试：文件哈希去重
    - **Property 4: 文件哈希去重**
    - **验证: 需求 3.7**
  - [x] 5.8 编写属性测试：简历上传后可检索
    - **Property 6: 简历上传后可检索**
    - **验证: 需求 3.2, 3.3**

- [x] 6. 简历筛选 API (/api/screening/)
  - [x] 6.1 创建筛选相关 Pydantic 模式
    - 创建 app/schemas/screening.py
    - 定义任务、报告、简历组相关模式
    - _需求: 1.2_
  - [x] 6.2 实现筛选任务提交 API
    - 实现 POST /api/screening/
    - 创建异步任务处理
    - _需求: 4.1_
  - [x] 6.3 实现任务列表和状态查询 API
    - 实现 GET /api/screening/tasks/
    - 实现 GET /api/screening/tasks/{task_id}/status/
    - 实现 DELETE /api/screening/tasks/{task_id}/
    - _需求: 4.2, 4.3, 4.4_
  - [x] 6.4 实现报告查询和下载 API
    - 实现 GET /api/screening/reports/{report_id}/
    - 实现 GET /api/screening/reports/{report_id}/download/
    - _需求: 4.5, 4.6_
  - [x] 6.5 实现简历数据 API
    - 实现 GET/POST /api/screening/data/
    - _需求: 4.7_
  - [x] 6.6 实现简历组管理 API
    - 实现 GET /api/screening/groups/
    - 实现 POST /api/screening/groups/create/
    - 实现 GET /api/screening/groups/{group_id}/
    - 实现 POST /api/screening/groups/add-resume/
    - 实现 POST /api/screening/groups/remove-resume/
    - 实现 POST /api/screening/groups/set-status/
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6_
  - [x] 6.7 实现视频关联 API
    - 实现 POST /api/screening/videos/link/
    - 实现 POST /api/screening/videos/unlink/
    - _需求: 6.1, 6.2_
  - [x] 6.8 实现开发测试工具 API
    - 实现 POST /api/screening/dev/generate-resumes/
    - 实现 GET/POST /api/screening/dev/force-error/
    - 实现 POST /api/screening/dev/reset-state/
    - _需求: 7.1, 7.2, 7.3_
  - [x] 6.9 编写属性测试：任务状态一致性
    - **Property 7: 任务状态一致性**
    - **验证: 需求 4.3**
  - [x] 6.10 编写属性测试：简历组成员计数
    - **Property 8: 简历组成员计数**
    - **验证: 需求 5.1**

- [x] 7. Checkpoint - 确保所有测试通过
  - [x] 确保所有测试通过，如有问题请询问用户

- [x] 8. 视频分析 API (/api/videos/)
  - [x] 8.1 创建视频分析 Pydantic 模式
    - 创建 app/schemas/video.py
    - _需求: 1.2_
  - [x] 8.2 实现视频分析 API
    - 实现 GET /api/videos/
    - 实现 POST /api/videos/upload/
    - 实现 POST /api/videos/{video_id}/
    - 实现 GET /api/videos/{video_id}/status/
    - _需求: 8.1, 8.2, 8.3, 8.4_

- [x] 9. 最终推荐 API (/api/recommend/)
  - [x] 9.1 创建推荐分析 Pydantic 模式
    - 创建 app/schemas/recommend.py
    - _需求: 1.2_
  - [x] 9.2 实现推荐统计和分析 API
    - 实现 GET /api/recommend/stats/
    - 实现 GET/POST /api/recommend/analysis/{resume_id}/
    - _需求: 9.1, 9.2, 9.3_

- [x] 10. 面试辅助 API (/api/interviews/)
  - [x] 10.1 创建面试辅助 Pydantic 模式
    - 创建 app/schemas/interview.py
    - _需求: 1.2_
  - [x] 10.2 实现会话管理 API
    - 实现 GET/POST /api/interviews/sessions/
    - 实现 GET/DELETE /api/interviews/sessions/{session_id}/
    - _需求: 10.1, 10.2, 10.3, 10.4_
  - [x] 10.3 实现问题生成和问答记录 API
    - 实现 POST /api/interviews/sessions/{session_id}/questions/
    - 实现 POST /api/interviews/sessions/{session_id}/qa/
    - _需求: 10.5, 10.6_
  - [x] 10.4 实现报告生成 API
    - 实现 POST /api/interviews/sessions/{session_id}/report/
    - _需求: 10.7_
  - [x] 10.5 编写属性测试：会话问答记录递增
    - **Property 9: 会话问答记录递增**
    - **验证: 需求 10.6**

- [x] 11. AI 服务集成
  - [x] 11.1 创建 AI 服务封装
    - 创建 app/services/ai_service.py
    - 封装 LLM 调用接口
    - _需求: 2.8, 4.1, 9.2, 10.5, 10.6, 10.7_
  - [x] 11.2 实现简历筛选 AI 逻辑
    - 创建 app/services/screening_service.py
    - 实现异步筛选任务处理
    - _需求: 4.1, 11.6_
  - [x] 11.3 实现面试辅助 AI 逻辑
    - 创建 app/services/interview_service.py
    - 实现问题生成和答案评估
    - _需求: 10.5, 10.6, 10.7_
  - [x] 11.4 实现综合分析 AI 逻辑
    - 创建 app/services/recommend_service.py
    - 实现候选人综合评估
    - _需求: 9.2_

- [x] 12. Agent 模块迁移（基于 AutoGen）
  - [x] 12.1 创建 app/agents/ 基础结构
    - 从 Django `services/agents/` 复制 `llm_config.py` 和 `base.py`
    - 安装依赖 `pyautogen>=0.2`
  - [x] 12.2 迁移简历筛选 Agent
    - 从 Django `services/agents/screening_agents.py` 复制，使用 AutoGen GroupChat 多 Agent 协作
  - [x] 12.3 迁移面试辅助 Agent
    - 从 Django `services/agents/interview_assist_agent.py` 复制
    - **跳过以下废弃/未使用的功能（死代码）**：
      - `evaluate_answer()` - 每句话实时评分，默认 skip_evaluation=True
      - `generate_followup_suggestions()` - 追问建议生成，代码存在但从未被调用
      - `_get_minimal_answer_evaluation()` - evaluate_answer 的辅助方法
      - `_get_fallback_evaluation()` - evaluate_answer 的备用方法
      - `_get_fallback_followup_suggestions()` - followup 的备用方法
      - `ANSWER_EVALUATION_PROMPT` - 评估提示词模板
      - `FOLLOWUP_SUGGESTION_PROMPT` - 追问提示词模板
  - [x] 12.4 迁移综合分析 Agent
    - 从 Django `services/agents/evaluation_agents.py` 复制
    - **跳过以下已删除的功能**：
      - `EvaluationAgentManager` - 旧版多 Agent 协作评估，已被 `CandidateComprehensiveAnalyzer` 替代
      - `run_evaluation()` - 批量评估功能，不再支持
  - [x] 12.5 迁移岗位生成 Agent
    - 从 Django `services/agents/position_ai_service.py` 复制
  - [x] 12.6 整合：更新 services 层调用 agents 模块（初版）
    - 保留 `ai_service.py` 作为基础服务类
    - 在 `services/__init__.py` 中整合导出 agents 模块
  - [x] 12.7 验证所有测试通过
    - 125 个测试全部通过
  - [x] 12.8 重构 services 层架构（二次调整）
    - **架构调整原则**：
      - `agents` 模块职责：只放 AI 核心实现（LLM 配置、AutoGen Agent、提示词模板等）
      - `services` 模块职责：`ai_service.py` 作为业务层统一入口，只做业务编排，具体 AI 逻辑委托给 agents
    - **删除旧服务文件**：
      - `app/services/interview_service.py`
      - `app/services/recommend_service.py`
      - `app/services/screening_service.py`
    - **重命名**：
      - `agents/position_ai_service.py` → `agents/position_generator.py`
      - 类名 `PositionAIService` → `PositionGenerator`
    - **重写 `ai_service.py`**：
      - 作为业务层统一入口
      - 包含 `PositionAIService`、`ResumeScreeningService`、`InterviewAssistService`、`ComprehensiveAnalysisService`
      - 每个服务类内部委托给对应的 agents 模块
    - **更新 API 层 import**：
      - `screening.py` → `from app.services.ai_service import get_screening_service`
      - `interviews.py` → `from app.services.ai_service import get_interview_assist_service`
      - `recommend.py` → `from app.services.ai_service import perform_comprehensive_analysis, get_comprehensive_analysis_service`
    - **更新 `services/__init__.py`**：简化为只导出业务层服务
    - 125 个测试全部通过

- [ ] 13. 最终 Checkpoint - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户
  - 验证所有 49 个 API 端点正常工作
  - 验证与前端的兼容性
